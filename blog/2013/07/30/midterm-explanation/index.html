
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Midterm explanation - GSoC 2013 - RTEMS Virtualization Layer Project</title>
  <meta name="author" content="Philipp Eppelt">

  
  <meta name="description" content="It is midterm evaluation time, so half the time is up and I want to write about
the changes I bring into the RTEMS project. This post will explain &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://phipse.github.io/rtems/blog/2013/07/30/midterm-explanation">
  <link href="/rtems/favicon.png" rel="icon">
  <link href="/rtems/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/rtems/atom.xml" rel="alternate" title="GSoC 2013 - RTEMS Virtualization Layer Project" type="application/atom+xml">
  <script src="/rtems/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/rtems/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/rtems/">GSoC 2013 - RTEMS Virtualization Layer Project</a></h1>
  
    <h2>Progress, Issues, Design</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/rtems/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:phipse.github.io/rtems" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/rtems/">Blog</a></li>
  <li><a href="/rtems/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Midterm Explanation</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-30T11:42:00+02:00" pubdate data-updated="true">Jul 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It is midterm evaluation time, so half the time is up and I want to write about
the changes I bring into the RTEMS project. This post will explain the patch I
created for midterm.</p>

<!--more-->


<h2>Overview</h2>

<p>I brought one major change to the project, the split of the i386 architecture
dependent code into a part in score and another part in libcpu.
Compared to this the virtualization layer consisting of two header files, one
for CPU dependent functionality and on for board dependent, is rather small.
The introduction of the new BSP called virtPOK is a bigger change, but still,
it only affects this project and not all building upon the i386 architecture.</p>

<h2>i386 split</h2>

<p>i386 has several instructions (hlt, cli, sti) which are not allowed in a
virtualized environment, as they affect other virtual machines. Functions in
cpukit/score/cpu/i386/ are using these instruction and therefore need to be
moved. However, these functions must remain in the native version of an RTEMS
i386 binary, but must be replaced with different implementations in a virtual
compilation.</p>

<p>RTEMS is providing with libcpu a place where CPUs with special features of the
same architecture can be specified. That is the place where the native and
virtual implementations of the mentioned functions need to go.
I introduced two new CPU models for the i386 architecture &ndash; native and virtual.
Native is used by the pc386-BSPs and should work like before. Virtual is the
new kid in the block and is only used by the virtPok BSP.</p>

<p>Configure.ac is controlling the choice of the bsp. As the config file for a BSP
specifies the CPU model, the virtPok.cfg is specifying <strong><em>virt-pok</em></strong> as CPU.
Configure.ac checks for this CPU model and sets a conditional if this model is
used. The conditional controls the path of execution in the corresponding
Makefile.am, which in turn chooses the virtual or native directory.</p>

<h2>Virtualization layer</h2>

<p>The virtualization layer consists of two parts: One for the CPU and one for the
BSP. My intention for the layer is to provide on BSP using the functionality of
the layer and then the layer must be implemented by the host/hypervisor and
provided as a library to RTEMS.</p>

<p>The CPU part needs to be implemented in RTEMS once for each architecture. The
BSP currently developed for i386 might be reusable on other architectures, as
the host cares for architecture dependent parts.</p>

<p>Both header files virtLayerBSP.h and virtLayerCPU.h can be found in
c/src/lib/libbsp/i386/virtPok/include/ .</p>

<h2>Virtual BSP</h2>

<p>The virtual BSP for i386 is called virtPok and is currently able to run the
hello world sample virtualized on POK. The BSP mimics the interface between
RTEMS and the host/hypervisor, by forwarding the RTEMS function calls to the
virtualization layer, which is implemented by the host and provided as a
library to the BSP. Currently implemented is a console driver to run the hello
world sample. A clock driver will be the next step but this needs changes in
POK first.</p>

<h2>Putting it all together</h2>

<p>To rebuild the current work, you can either checkout my virt-bsp branch from:
<a href="https://github.com/phipse/rtems">github</a></p>

<p>Or you can apply the patches from the rtems-devel mailing list to the current
RTEMS git head.</p>

<p>Then you need to follow my explanations from the <a href="http://phipse.github.io/rtems/blog/2013/07/08/HelloWorld/" title="Hello World">Hello
World</a>
blog post.</p>

<p>Unfortunately, you need to build RTEMS with <strong>make -j1</strong> as parallel
compilation can lead to undefined reference errors.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Philipp Eppelt</span></span>

      








  


<time datetime="2013-07-30T11:42:00+02:00" pubdate data-updated="true">Jul 30<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/rtems/blog/2013/07/28/generation-of-libpart-target/" title="Previous Post: Generation of libpart target">&laquo; Generation of libpart target</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/rtems/blog/2013/07/30/midterm-explanation/">Midterm Explanation</a>
      </li>
    
      <li class="post">
        <a href="/rtems/blog/2013/07/28/generation-of-libpart-target/">Generation of Libpart Target</a>
      </li>
    
      <li class="post">
        <a href="/rtems/blog/2013/07/09/how-late-is-it/">How Late Is It?</a>
      </li>
    
      <li class="post">
        <a href="/rtems/blog/2013/07/08/HelloWorld/">Hello World - Describing the Build Process</a>
      </li>
    
      <li class="post">
        <a href="/rtems/blog/2013/07/07/Modeling-the-partition/">Memory Partition and Pointers</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/phipse">@phipse</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'phipse',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/rtems/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Philipp Eppelt -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
